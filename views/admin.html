<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #333; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 10px; text-align: left; }
    button { padding: 5px 10px; margin: 2px; cursor: pointer; }
    .approved { background: green; color: white; }
    .rejected { background: red; color: white; }
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>

  <h2>ðŸ‘¥ Users</h2>
  <table id="usersTable">
    <thead>
      <tr>
        <th>Email</th>
        <th>Role</th>
        <th>Balance</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>ðŸ’¸ Withdrawal Requests</h2>
  <table id="withdrawalsTable">
    <thead>
      <tr>
        <th>User</th>
        <th>Method</th>
        <th>Address</th>
        <th>Amount</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const token = localStorage.getItem("token"); // âœ… Assume admin already logged in & token stored

    if (!token) {
      alert("No token found! Please login as admin.");
      window.location.href = "/login";
    }

    // Helper: fetch with auth
    async function apiFetch(url, options = {}) {
      const res = await fetch(url, {
        ...options,
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        }
      });
      return res.json();
    }

   // Load users
  async function loadUsers() {
    const data = await apiFetch("/api/admin/users");
    const tbody = document.querySelector("#usersTable tbody");
    tbody.innerHTML = "";

    data.users.forEach(user => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${user.email}</td>
        <td>${user.role}</td>
       <td>
    Wallet: ${user.wallet || 0}<br>
    Profit: ${user.profit || 0}<br>
    FundsWithdraw: ${user.fundswithdraw || 0}<br>
    Airdrop: ${user.airdrop || 0}<br>
    AirProfit: ${user.airprofit || 0}<br>
    AirWithdraw: ${user.airwithdraw || 0}
  </td>
  <td>
    <select id="field-${user._id}">
      <option value="wallet">Wallet</option>
      <option value="profit">Profit</option>
      <option value="fundswithdraw">FundsWithdraw</option>
      <option value="airdrop">Airdrop</option>
      <option value="airprofit">AirProfit</option>
      <option value="airwithdraw">AirWithdraw</option>
    </select>
    <input type="text" id="amount-${user._id}" placeholder="Enter amount (+/-)" />
    <button onclick="adjustField('${user._id}')">Update</button>
    <button onclick="deleteUser('${user._id}')" style="background:red;color:white;">ðŸ—‘ Delete</button>
  </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function adjustField(userId) {
  const field = document.getElementById(`field-${userId}`).value;
  let amount = document.getElementById(`amount-${userId}`).value.trim();

  // âœ… Clean up commas
  amount = Number(amount.replace(/,/g, ""));
  if (isNaN(amount) || amount === 0) {
    return alert("Please enter a valid amount (positive or negative)");
  }

  const res = await apiFetch(`/api/admin/users/${userId}/adjust`, {
    method: "POST",
    body: JSON.stringify({ field, amount })
  });

  alert(res.message);
  loadUsers();
}



  // ðŸ—‘ Delete user function
  async function deleteUser(userId) {
    if (!confirm("Are you sure you want to delete this user?")) return;

    const res = await apiFetch(`/api/admin/users/${userId}`, {
      method: "DELETE"
    });

    alert(res.message);
    loadUsers();
  }


    // Load withdrawals
    async function loadWithdrawals() {
      const data = await apiFetch("/api/admin/withdrawals");
      const tbody = document.querySelector("#withdrawalsTable tbody");
      tbody.innerHTML = "";

      data.withdrawals.forEach(w => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${w.userId}</td>
          <td>${w.method}</td>
          <td>${w.address}</td>
          <td>${w.amount}</td>
          <td>${w.status}</td>
          <td>
            <button class="approved" onclick="updateWithdrawal('${w._id}', 'approved')">Approve</button>
            <button class="rejected" onclick="updateWithdrawal('${w._id}', 'rejected')">Reject</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function updateWithdrawal(id, status) {
      const res = await apiFetch(`/api/admin/withdrawals/${id}/status`, {
        method: "POST",
        body: JSON.stringify({ status })
      });
      alert(res.message);
      loadWithdrawals();
    }

    // Load data on page load
    loadUsers();
    loadWithdrawals();
  </script>
  

  <section id="invite-admin-section" style="margin-top:30px;padding:16px;border:1px solid #e2e8f0;border-radius:8px;">
    <h3>Generate Access Link</h3>
    <form id="inviteForm" style="display:flex;gap:8px;flex-wrap:wrap;">
      <label>Max uses
        <input type="number" name="maxUses" value="1" min="1" style="width:80px;margin-left:6px"/>
      </label>
      <label>Expires (days)
        <input type="number" name="expiresInDays" value="7" min="1" style="width:80px;margin-left:6px"/>
      </label>
      <input type="text" name="notes" placeholder="Notes (optional)" style="flex:1;min-width:200px"/>
      <button type="submit" id="generateInviteBtn">Generate Access Link</button>
    </form>
  
    <div id="inviteLinkBox" style="margin-top:15px;"></div>
  
    <h4 style="margin-top:18px">Existing Invites</h4>
    <div id="invitesList" style="margin-top:8px;"></div>
  </section>
  
  <script>
    const inviteForm = document.getElementById("inviteForm");
    const inviteLinkBox = document.getElementById("inviteLinkBox");
    const invitesList = document.getElementById("invitesList");
  
    inviteForm.addEventListener("submit", async (e) => {
      e.preventDefault();
  
      const maxUses = parseInt(inviteForm.maxUses.value);
      const expiresInDays = parseInt(inviteForm.expiresInDays.value);
      const notes = inviteForm.notes.value;
  
      if (!maxUses || !expiresInDays) {
        return alert("Please enter valid max uses and expiry days");
      }
  
      const btn = document.getElementById("generateInviteBtn");
      btn.disabled = true;
      btn.textContent = "Generating...";
  
      try {
        const res = await fetch("/api/admin/invites", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("token"),
          },
          body: JSON.stringify({ maxUses, expiresInDays, notes }),
        });
  
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || "Failed to generate invite.");
  
        inviteLinkBox.innerHTML = `
          <div style="background:#e8f0fe;border:1px solid #90caf9;padding:15px;border-radius:8px;margin-top:15px;">
            <p><strong>âœ… Invite Link Generated:</strong></p>
            <input type="text" id="inviteLink" value="${data.inviteLink}" readonly style="width:100%;padding:6px;border-radius:4px;margin-top:5px;">
            <button onclick="navigator.clipboard.writeText(document.getElementById('inviteLink').value)" 
              style="margin-top:10px;background:#007bff;color:white;border:none;padding:6px 10px;border-radius:5px;cursor:pointer;">
              Copy Link
            </button>
            <p style="margin-top:8px;color:#555;">Expires: ${new Date(data.expiresAt).toLocaleString()} | Uses allowed: ${data.maxUses}</p>
          </div>
        `;
  
        loadInvites();
      } catch (err) {
        console.error(err);
        alert("âš ï¸ Server error while generating invite.");
      } finally {
        btn.disabled = false;
        btn.textContent = "Generate Access Link";
      }
    });
  
    async function loadInvites() {
      try {
        const res = await fetch("/api/admin/invites", {
          headers: {
            "Authorization": "Bearer " + localStorage.getItem("token"),
          },
        });
        const data = await res.json();
        if (!res.ok) throw new Error("Failed to load invites");
  
        invitesList.innerHTML = data.invites.map(inv =>
          `<div style="border:1px solid #ccc;padding:8px;margin-top:6px;border-radius:6px;">
            <b>Token:</b> ${inv._id}<br>
            <b>Uses:</b> ${inv.uses}/${inv.maxUses}<br>
            <b>Expires:</b> ${new Date(inv.expiresAt).toLocaleString()}<br>
            <button onclick="revokeInvite('${inv._id}')"
              style="background:red;color:white;padding:4px 8px;border:none;border-radius:4px;margin-top:4px;">
              Revoke
            </button>
          </div>`
        ).join("");
      } catch (e) {
        console.error(e);
        invitesList.textContent = "Error loading invites.";
      }
    }
  
    async function revokeInvite(id) {
      if (!confirm("Revoke this invite?")) return;
      await fetch(`/api/admin/invites/${id}/revoke`, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + localStorage.getItem("token"),
        },
      });
      loadInvites();
    }
  
    loadInvites();
  </script>
  


</body>
</html>
